<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>snake</title>
    </head>
    <style>
    </style>
    <body>
        <input type="button" value="Start" onclick="beginGame()"/>
        <canvas id="myCanvas"></canvas>
        <input type="button" value="Stop" onclick="stop()"/>
    </body>
    <script>
    var bgHeight = 20;
    var bgWidth = 20;
    var snakeSize = 30;
    var myCanvas = document.getElementById("myCanvas");
    myCanvas.setAttribute("width",bgWidth*(snakeSize+1));
    myCanvas.setAttribute("height",bgHeight*(snakeSize+1));
    var ctx = myCanvas.getContext("2d");
    
    var head = new Node(parseInt(Math.random()*bgWidth),parseInt(Math.random()*bgHeight),null,null);
    var tail = head;
    var len = 1;
    var food;
    var alive = true;
    var keyCode;
    var tailPre,newHead;
    var i;
    var current;
    generateFood();

    console.log(" x: "+head.x+" y: "+head.y);

    function Node(x,y,pre,next)
    {
        this.x = x;
        this.y = y;
        this.pre = pre;
        this.next = next;
        return this;
    }

    function generateFood()
    {
        food = new Node(parseInt(Math.random()*bgWidth),parseInt(Math.random()*bgHeight),null,null);
    }

    function draw()
    {
        ctx.clearRect(0,0,bgWidth*snakeSize,bgHeight*snakeSize);
        console.log("drawing..");
        // tab
        for(i=0;i<=bgHeight;i++)
        {
            ctx.strokeStyle = "#ccc" ;
            ctx.beginPath();
            ctx.moveTo(0,i*snakeSize);
            ctx.lineTo(bgWidth*snakeSize,i*snakeSize);
        }
        for(i=0;i<bgWidth;i++)
        {
            ctx.strokeStyle = "#ccc" ;
            ctx.beginPath();
            ctx.moveTo(i*snakeSize,0);
            ctx.lineTo(i*snakeSize,bgHeight*snakeSize);
        }
        // food
        drawNode(food,"yellow");
        // head
        // body
        current = head;
        i = 0;
        while(current != null && i<len)
        {
            if(i==0)
            {
                drawHead(current);
            }
            else if(i==len-1)
            {
                drawTail(current);
            }
            else
            {
                drawNode(current,"black")
            }
            console.log("draw"+len);
            current = current.next;
            i++;
        }
        drawScore();
    }

    function drawScore()
    {
        ctx.font="10px Georgia";
        ctx.fillText("Your Score : " + len, bgWidth*(snakeSize-2) ,snakeSize+3,snakeSize);
    }

    function drawTail(node)
    {
        drawNode(node,"blue");
    }

    function drawHead(head)
    {
        var size = snakeSize/2;
        console.log("head");
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(head.x*snakeSize + size,head.y*snakeSize+size,size,0,Math.PI*2,true);
        ctx.fill();
    }

    document.onkeydown = function(e)
    {
        keyCode = e.keyCode;
    }

    function stop()
    {
        this.alive = false;
    }

    function drawNode(node,color)
    {
        ctx.fillStyle = color;
        ctx.fillRect((node.x)*snakeSize,(node.y)*snakeSize,snakeSize,snakeSize);
    }

    function move(keyCode)
    {
        var nextX = head.x;
        var nextY = head.y;
        switch(keyCode)
        {
            // down
            case 40:
                nextY++;
                break;
            // right
            case 39:
                nextX++;
                break;
            //up
            case 38:
                nextY--;
                break;
            //left
            case 37:
                nextX--;
                break;
            default:
                break;
        }
        tail.x = nextX;
        tail.y = nextY;
        if(len > 1)
        {
            tailPre = tail.pre;
            tail.pre = null;
            tail.next = head;
            newHead = tail;
            tailPre.next = null;
            head.pre = newHead;
            head = newHead;
            tail = tailPre;
        }
        //eat
        if(food.x == head.x && food.y == head.y)
        {
            tail.next = food;
            food.pre = tail;
            tail = food;
            generateFood();
            len++;
        }
        isAlive();
        draw();
    }

    function isAlive()
    {
        current = head.next;
        while(current != null)
        {
            // eat itself
            if(current.x == head.x && current.y == head.y)
            {
                console.log("eat itself");
                alive = false;
                return;
            }
            current = current.next;
        }
        if(head.x<0)head.x = bgWidth * snakeSize + head.x;
        if(head.y<0)head.y = bgHeight * snakeSize + head.y;
        if(head.x>bgWidth) head.x = head.x % bgWidth;
        if(head.y>bgHeight) head.y = head.y % bgHeight;
    }

    function beginGame()
    {
        setInterval("move(keyCode)",200);
    }


    </script>
</html>